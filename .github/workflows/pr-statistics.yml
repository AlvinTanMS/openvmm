---
name: PR Statistics

on:
  schedule:
    - cron: '0 0 * * 1'  # Weekly on Mondays at midnight UTC
  workflow_dispatch:
    inputs:
      days:
        description: 'Analysis period in days'
        required: false
        default: '30'
        type: string
  pull_request:
    # Temporary trigger for testing - will be removed before final submission

permissions:
  contents: read
  pull-requests: read
  issues: read

jobs:
  pr-statistics:
    runs-on: ubuntu-latest
    name: Generate Pull Request Statistics

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Calculate Date Range
        id: date-range
        run: |
          days="${{ github.event.inputs.days || '30' }}"
          start_date=$(date -d "$days days ago" +%Y-%m-%d)
          echo "start_date=$start_date" >> $GITHUB_OUTPUT

      - name: Collect PR Statistics
        uses: github/issue-metrics@v2
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SEARCH_QUERY: >-
            repo:${{ github.repository }}
            is:pr
            created:>=${{ steps.date-range.outputs.start_date }}
            -author:app/github-copilot
            -author:dependabot[bot]
            -author:github-actions[bot]

      - name: Generate Report
        run: |
          mkdir -p .github/reports
          report_date=$(date +%Y-%m-%d)
          current_date=$(date)

          cat << EOF > .github/reports/pr-statistics-${report_date}.md
          # Pull Request Statistics Report

          **Repository:** ${{ github.repository }}
          **Generated:** ${current_date}
          **Period:** Last ${{ github.event.inputs.days || '30' }} days

          ## Overview

          This report provides insights into pull request activity including:
          - Review velocity and patterns
          - Time to merge statistics  
          - Team collaboration metrics
          - Development workflow efficiency

          **Note:** Bot accounts (GitHub Copilot, Dependabot, GitHub Actions) are excluded 
          from statistics to focus on human team collaboration patterns.

          ## Key Metrics

          - **Pull Request Creation Rate:** Frequency of new PRs
          - **Review Turnaround Time:** Time from creation to first review
          - **Merge Time:** Average time from creation to merge
          - **Reviewer Participation:** Distribution of review activity
          - **Size Analysis:** PR size trends and patterns

          ## Usage

          These metrics help teams:
          - Identify review bottlenecks
          - Optimize development workflows
          - Balance reviewer workloads
          - Track process improvements over time

          ---
          *Generated automatically by GitHub Actions*
          EOF

          echo "Report generated successfully"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pr-statistics-${{ github.run_number }}
          path: |
            .github/reports/pr-statistics-*.md
            issue_metrics.md
          retention-days: 90

      - name: Job Summary
        run: |
          echo "# PR Statistics Generated ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          days="${{ github.event.inputs.days || '30' }}"
          echo "Period: ${days} days" >> $GITHUB_STEP_SUMMARY
          echo "Report artifacts uploaded with 90-day retention" >> $GITHUB_STEP_SUMMARY